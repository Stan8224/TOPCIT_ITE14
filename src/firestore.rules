/**
 * @file firestore.rules
 * @description Firestore Security Rules for a course progress tracking application.
 *
 * @section Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user-generated data, such as
 * course enrollments and assignment submissions, is stored in subcollections under that
 * user's document. This makes authorization simple, secure, and performant by leveraging
 * the document path for access control, eliminating the need for extra database reads.
 *
 * @section Data Structure
 * - `/users/{userId}`: Private user profile data.
 * - `/users/{userId}/courseEnrollments/{enrollmentId}`: Private records of courses a user is enrolled in.
 * - `/users/{userId}/assignments/{assignmentId}/submissions/{submissionId}`: Private submissions for assignments.
 * - `/courses/{courseId}`: Publicly readable course information.
 * - `/courses/{courseId}/assignments/{assignmentId}`: Publicly readable assignment details.
 *
 * @section Key Security Decisions
 * - User Enumeration: Listing users from the top-level `/users` collection is disabled to protect user privacy.
 * - User-Scoped Data: A user can only access documents within their own data tree (i.e., paths starting with `/users/{request.auth.uid}`).
 * - Public Content: Course and assignment information is readable by any authenticated user, but write access is disabled by default until a proper admin/creator role is defined in the data model. This provides a secure-by-default posture for course content management.
 * - Authorization-Critical Fields: On creation, we enforce that internal `userId` fields match the user ID in the path to ensure data integrity and prevent users from creating records on behalf of others. These fields are immutable on update.
 *
 * @section Denormalization for Authorization
 * The data model is designed around authorization. By nesting a user's submissions
 * under their own `/users/{userId}` path, we can use a simple path-based rule like
 * `isOwner(userId)` instead of performing a costly and slow `get()` on a separate
 * document to verify ownership. This is the cornerstone of the "Authorization Independence"
 * principle mentioned in the system design.
 *
 * @section Structural Segregation
 * The ruleset leverages separate collections for public and private data. Public course
 * content is in `/courses`, while private user progress is in `/users/{userId}` subcollections.
 * This separation is more secure and performant for list operations than mixing public and
 * private documents in the same collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document.
     * Used for update and delete operations to prevent modifying non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // -------------------------------------------------------------------------
    // User Profiles (/users)
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (create) - A user can create their own profile document. `auth.uid` must match `{userId}`.
     * @allow (get, update, delete) - A user can read, update, or delete their own profile.
     * @deny (list) - Listing all users is forbidden to prevent user enumeration.
     * @deny (get) - An authenticated user cannot read another user's profile.
     * @principle Restricts access to a user's own data tree and enforces relational integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      // -----------------------------------------------------------------------
      // Course Enrollments (/users/{userId}/courseEnrollments)
      // -----------------------------------------------------------------------

      /**
       * @description Manages a user's course enrollment records.
       * @path /users/{userId}/courseEnrollments/{courseEnrollmentId}
       * @allow (all) - A user can fully manage their own enrollment records.
       * @deny (all) - A user cannot access another user's enrollment records.
       * @principle Enforces strict document ownership within a user's private subcollection.
       */
      match /courseEnrollments/{courseEnrollmentId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
      }

      // -----------------------------------------------------------------------
      // Submissions (/users/{userId}/assignments/{assignmentId}/submissions)
      // -----------------------------------------------------------------------

      /**
       * @description Manages a user's submissions for a specific assignment.
       * @path /users/{userId}/assignments/{assignmentId}/submissions/{submissionId}
       * @allow (all) - A user can create, read, update, and delete their own submissions.
       * @deny (all) - A user cannot access another user's submissions.
       * @principle Enforces strict document ownership by leveraging the user ID from the path.
       */
      match /assignments/{assignmentId}/submissions/{submissionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
      }
    }

    // -------------------------------------------------------------------------
    // Courses (/courses)
    // -------------------------------------------------------------------------

    /**
     * @description Manages course information documents.
     * @path /courses/{courseId}
     * @allow (get, list) - Any authenticated user can read course information.
     * @deny (create, update, delete) - Writes are disabled as there's no owner/admin field.
     * @principle Provides public read access for general content while maintaining a secure-by-default write posture.
     */
    match /courses/{courseId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      // CRITICAL: Cannot implement owner-only writes. The 'Course' entity is missing an 'ownerId' or 'authorId' field.
      allow create, update, delete: if false; // TODO: Add owner/admin validation once the schema is updated with an ownership field.

      // -----------------------------------------------------------------------
      // Assignments (/courses/{courseId}/assignments)
      // -----------------------------------------------------------------------

      /**
       * @description Manages assignment details nested under a course.
       * @path /courses/{courseId}/assignments/{assignmentId}
       * @allow (get, list) - Any authenticated user can read assignment details.
       * @deny (create, update, delete) - Writes are disabled as there's no owner/admin field.
       * @principle Provides public read access for content nested under a public parent document.
       */
      match /assignments/{assignmentId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        // CRITICAL: Cannot implement owner-only writes. The 'Assignment' entity is missing an 'ownerId' or 'authorId' field.
        allow create, update, delete: if false; // TODO: Add owner/admin validation once the schema is updated with an ownership field.
      }
    }
  }
}